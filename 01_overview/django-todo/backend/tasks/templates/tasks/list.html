{% extends 'base.html' %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="display-6 fw-bold">My Tasks</h1>
    <a href="/todos/create/" class="btn btn-primary btn-lg">
      <i class="bi bi-plus-lg"></i>
      <span class="ms-2">Add Task</span>
    </a>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <form class="row gy-2 gx-3 align-items-center" method="get">
        <div class="col-12">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" name="q" placeholder="Search tasks..." value="{{ filters.q }}">
          </div>
        </div>

        <div class="col-md-3">
          <select class="form-select" name="status">
            <option value="all" {% if filters.status == 'all' %}selected{% endif %}>All</option>
            <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Active</option>
            <option value="done" {% if filters.status == 'done' %}selected{% endif %}>Completed</option>
          </select>
        </div>

        <div class="col-md-3">
          <select class="form-select" name="category">
            <option value="all" {% if filters.category == 'all' %}selected{% endif %}>All categories</option>
            <option value="work" {% if filters.category == 'work' %}selected{% endif %}>Work</option>
            <option value="study" {% if filters.category == 'study' %}selected{% endif %}>Study</option>
            <option value="personal" {% if filters.category == 'personal' %}selected{% endif %}>Personal</option>
            <option value="shopping" {% if filters.category == 'shopping' %}selected{% endif %}>Shopping</option>
            <option value="other" {% if filters.category == 'other' %}selected{% endif %}>Other</option>
          </select>
        </div>

        <div class="col-md-3">
          <select class="form-select" name="priority">
            <option value="all" {% if filters.priority == 'all' %}selected{% endif %}>All priorities</option>
            <option value="high" {% if filters.priority == 'high' %}selected{% endif %}>High</option>
            <option value="medium" {% if filters.priority == 'medium' %}selected{% endif %}>Medium</option>
            <option value="low" {% if filters.priority == 'low' %}selected{% endif %}>Low</option>
          </select>
        </div>

        <div class="col-md-3">
          <select class="form-select" name="order_by">
            <option value="due_date" {% if filters.order_by == 'due_date' %}selected{% endif %}>By deadline (nearest)</option>
            <option value="-due_date" {% if filters.order_by == '-due_date' %}selected{% endif %}>By deadline (farthest)</option>
            <option value="priority" {% if filters.order_by == 'priority' %}selected{% endif %}>By priority (high first)</option>
            <option value="-priority" {% if filters.order_by == '-priority' %}selected{% endif %}>By priority (low first)</option>
          </select>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-outline-primary">Apply filters</button>
        </div>
      </form>
    </div>
  </div>

  {% if todos %}
    <div class="d-flex flex-column gap-3">
      {% for todo in todos %}
        <div class="task-card rounded-3 border bg-white p-3 shadow-sm{% if todo.is_resolved %} opacity-50{% endif %}">
          <div class="d-flex align-items-start gap-3">
            <form method="post" action="{% url 'tasks:toggle' todo.id %}">
              {% csrf_token %}
              <input class="form-check-input mt-1 task-checkbox" type="checkbox" onchange="saveScroll(); this.form.submit()" {% if todo.is_resolved %}checked{% endif %}>
            </form>

            <div class="flex-grow-1">
              <h3 class="h5 fw-semibold{% if todo.is_resolved %} task-completed{% endif %}">{{ todo.title }}</h3>
              {% if todo.description %}
                <p class="text-muted small mb-2">{{ todo.description }}</p>
              {% endif %}

              <div class="d-flex flex-wrap gap-2">
                <span class="badge text-bg-secondary">{{ todo.get_category_display }}</span>
                {% if todo.priority == 'high' %}
                  <span class="badge text-bg-danger">High</span>
                {% elif todo.priority == 'medium' %}
                  <span class="badge text-bg-warning">Medium</span>
                {% else %}
                  <span class="badge text-bg-success">Low</span>
                {% endif %}
              </div>
            </div>

            <div class="text-end">
              {% if not todo.due_date %}
                <span class="text-muted small">No due date</span>
              {% elif todo.due_date < today and not todo.is_resolved %}
                <div class="d-flex flex-column align-items-end">
                  <span class="badge text-bg-danger">Overdue</span>
                  <span class="small text-danger fw-medium">{{ todo.due_date|date:'j M' }}</span>
                </div>
              {% elif todo.due_date == today %}
                <div class="d-flex flex-column align-items-end">
                  <span class="badge text-bg-warning">Today</span>
                  <span class="small text-muted">{{ todo.due_date|date:'j M' }}</span>
                </div>
              {% else %}
                <span class="small text-muted">{{ todo.due_date|date:'j M Y' }}</span>
              {% endif %}

              <div class="task-actions mt-2 d-flex gap-2 justify-content-end">
                <a href="{% url 'tasks:edit' todo.id %}" class="btn btn-sm btn-outline-secondary me-2" title="Edit">
                  <i class="bi bi-pencil"></i>
                </a>
                <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ todo.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="deleteModal{{ todo.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Delete confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete this task? This action cannot be undone.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'tasks:delete' todo.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Delete</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <p class="text-muted fs-5">No tasks found</p>
      <p class="small text-muted">Try adjusting filters or create a new task</p>
    </div>
  {% endif %}

{% endblock %}
